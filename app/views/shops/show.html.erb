<%= stylesheet_link_tag "shops", :media => "all" %>

<%= render 'choices'%>

<div id="condition">
  <p>選択された条件
  <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>
  &nbsp;&nbsp;
  </p>
  <div id="labels">
    <% @shops.each do |shop| %>
      <% if @selected_shop_ids && @selected_shop_ids.include?(shop.id) %>
        <div class="bootstrap_btn_wrapper"><button type="button" class="btn btn-sm btn-success"><%= shop.name %> <span class="badge"><%= @hit_branches_count[shop.id.to_s] %>件</span></button></div>
      <% end %>
    <% end %>
    <% @prefectures.each do |prefecture| %>
      <% if @selected_prefecture_ids && @selected_prefecture_ids.include?(prefecture.id) %>
        <div class="bootstrap_btn_wrapper"><button type="button" class="btn btn-sm btn-danger"><%= prefecture.name %></button></div>
      <% end %>
    <% end %>
  </div>
  <div class="clear"></div>
</div>

<% if @error_msg %>
  <div class="error alert alert-danger" role="alert">
    <strong>すみません、エラーが発生しました。<br><a href="/">TOPページ</a>からやり直して下さい。</strong>
  </div>
<% elsif @branch_markers.length == 0 %>
  <div class="error alert alert-danger" role="alert">
    該当する店舗が見つかりませんでした。
  </div>
<% else %>
  <input id="pac-input" class="controls" type="text" placeholder="Search Box">
  <div id="map"></div>
<% end %>

<script>
handler = Gmaps.build('Google');
handler.buildMap({ internal: {id: 'map'}}, function(){
  markers = handler.addMarkers(<%=raw @branch_markers.to_json %>);
  handler.bounds.extendWith(markers);
  handler.fitMapToBounds();
});

var input = document.getElementById('pac-input');
var searchBox = new google.maps.places.SearchBox(input);
var map = handler.getMap();
map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

var old_marker;
searchBox.addListener('places_changed', function() {
  var places = searchBox.getPlaces();
  if (places.slength == 0) {
    return;
  }
  var place = places[0]
  old_marker = place;

  // Create a marker for each place.
  handler.addMarker({
    map:   map,
    title: place.name,
    lat:   place.geometry.location.lat(),
    lng:   place.geometry.location.lng()
  });
  console.log(map);

  var bounds = new google.maps.LatLngBounds();
  if (place.geometry.viewport) {
    // Only geocodes have viewport.
    bounds.union(place.geometry.viewport);
    map.fitBounds(bounds);
  } else {
    bounds.extend(place.geometry.location);
    map.fitBounds(bounds);
    map.setZoom(15)
  }
});

// ブラウザ判定してdivサイズを可変に
var useragent = navigator.userAgent;
var mapdiv = $("#map");
if (useragent.indexOf('iPhone') != -1 || useragent.indexOf('Android') != -1 ) {
  mapdiv.style.width = '100%';
  mapdiv.style.height = '100%';
} else {
  mapdiv.style.width = '600px';
  mapdiv.style.height = '800px';
}
</script>

