<%= stylesheet_link_tag "shops", :media => "all" %>

<%= render 'choices'%>

<div id="labels">
  <span style="font-size: 14px;line-height: 32px;">選択された条件
    <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>
    &nbsp;&nbsp;
  </span>
  <% @shops.each do |shop| %>
    <% if @selected_shop_ids && @selected_shop_ids.include?(shop.id) %>
      <div class="bootstrap_btn_wrapper" ><button type="button" class="btn btn-sm btn-success"><%= shop.name %> <span class="badge"><%= @hit_branches_count[shop.id.to_s] %>件</span></button></div>
    <% end %>
  <% end %>
  <br>
  <% @prefectures.each do |prefecture| %>
    <% if @selected_prefecture_ids && @selected_prefecture_ids.include?(prefecture.id) %>
      <button type="button" class="btn btn-sm btn-danger"><%= prefecture.name %></button>
    <% end %>
  <% end %>
</div>

<% if @error_msg %>
  <div class="error alert alert-danger" role="alert">
    <strong>すみません、エラーが発生しました。<br><a href="/">TOPページ</a>からやり直して下さい。</strong>
  </div>
<% elsif @branch_markers.length == 0 %>
  <div class="error alert alert-danger" role="alert">
    該当する店舗が見つかりませんでした。
  </div>
<% else %>
  <input id="pac-input" class="controls" type="text" placeholder="Search Box">
  <div id="map"></div>
<% end %>
<script>
// TODO
// ショップや都道府県が多く選択されるとラベルが増え、GoogleMapがはみ出てしまう(footerに侵食する)
// 動的にサイズを調整しようとしたがどうにもできないので後回し
// $(document).ready(function() {
//   var header_height = 50, footer_height = 20;
//   var max_main_height = $("body").height() - header_height - footer_height;
//   
//   var main_height = $("#labels").height() + $("#choices").height() + $("#map").height();
//   
//   console.log($("#map").height());
//   if( main_height > max_main_height){
//     exceeded_px = main_height - max_main_height;
//     $("#map").height($("#map").height() - exceeded_px);
//     console.log($("#map").height());
//   }
// });
handler = Gmaps.build('Google');
handler.buildMap({ internal: {id: 'map'}}, function(){
  markers = handler.addMarkers(<%=raw @branch_markers.to_json %>);
  handler.bounds.extendWith(markers);
  handler.fitMapToBounds();
});

var input = document.getElementById('pac-input');
var searchBox = new google.maps.places.SearchBox(input);
var map = handler.getMap();
map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

var old_marker;
searchBox.addListener('places_changed', function() {
  var places = searchBox.getPlaces();
  if (places.slength == 0) {
    return;
  }
  var place = places[0]
  old_marker = place;

  // Create a marker for each place.
  handler.addMarker({
    map:   map,
    title: place.name,
    lat:   place.geometry.location.lat(),
    lng:   place.geometry.location.lng()
  });
  console.log(map);

  var bounds = new google.maps.LatLngBounds();
  if (place.geometry.viewport) {
    // Only geocodes have viewport.
    bounds.union(place.geometry.viewport);
    map.fitBounds(bounds);
  } else {
    bounds.extend(place.geometry.location);
    map.fitBounds(bounds);
    map.setZoom(15)
  }
});
</script>

